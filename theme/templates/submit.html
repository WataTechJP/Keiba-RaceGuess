<!-- prettier-ignore -->
{% extends 'base.html' %}
{% block title %}予想を投稿{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold text-blue-600 mb-4">予想を投稿</h1>

<form method="POST" class="space-y-4">
  {% csrf_token %} {{ form.as_p }}
  <button
    type="submit"
    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
  >
    投稿する
  </button>
</form>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const raceSelect = document.getElementById("id_race");
    const firstSelect = document.getElementById("id_first_position");
    const secondSelect = document.getElementById("id_second_position");
    const thirdSelect = document.getElementById("id_third_position");

    function populateHorseOptions(horses) {
      [firstSelect, secondSelect, thirdSelect].forEach((select) => {
        select.innerHTML = "";

        const emptyOption = document.createElement("option");
        emptyOption.value = "";
        emptyOption.textContent = "---------";
        select.appendChild(emptyOption);

        horses.forEach((horse) => {
          const option = document.createElement("option");
          option.value = horse.id;
          option.textContent = horse.name;
          select.appendChild(option);
        });
      });

      // 初期化後にもフィルターを適用
      filterOptions();
    }

    function filterOptions() {
      const selectedFirst = firstSelect.value;
      const selectedSecond = secondSelect.value;
      const selectedThird = thirdSelect.value;

      const selectedValues = [
        selectedFirst,
        selectedSecond,
        selectedThird,
      ].filter((v) => v !== "");

      [firstSelect, secondSelect, thirdSelect].forEach((currentSelect) => {
        Array.from(currentSelect.options).forEach((option) => {
          if (option.value === "") {
            option.disabled = false;
            return;
          }

          // 自分のセレクトで選んでいる値は除外対象から外す
          const currentValue = currentSelect.value;
          const isSelectedInOther =
            selectedValues.includes(option.value) &&
            option.value !== currentValue;

          option.disabled = isSelectedInOther;
        });
      });
    }

    raceSelect.addEventListener("change", function () {
      const raceId = this.value;
      if (!raceId) return;

      fetch(`/api/horses/?race_id=${raceId}`)
        .then((response) => response.json())
        .then((data) => {
          populateHorseOptions(data);
        });
    });

    [firstSelect, secondSelect, thirdSelect].forEach((select) =>
      select.addEventListener("change", filterOptions)
    );
  });
</script>

<a
  href="{% url 'prediction_list' %}"
  class="text-sm text-blue-500 mt-4 inline-block"
>
  → 予想一覧へ
</a>
{% endblock %}
